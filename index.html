<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <title>AlphBanX Calculator</title>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://abx.notrustverify.ch/" />
    <meta property="og:title" content="AlphBanX Calculator" />
    <meta property="og:description" content="Calculate your liquidation risk, maximum borrowable ABD, and safety margins for AlphBanx loans. Real-time price updates and position monitoring." />
    <!-- <meta property="og:image" content="https://notrustverify.ch/alph-calculator/og-image.png" /> -->
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://abx.notrustverify.ch/" />
    <meta property="twitter:title" content="AlphBanX Calculator" />
    <meta property="twitter:description" content="Calculate your liquidation risk, maximum borrowable ABD, and safety margins for AlphBanx loans. Real-time price updates and position monitoring." />
    <!-- <meta property="twitter:image" content="https://notrustverify.ch/alph-calculator/og-image.png" /> -->
    <meta property="twitter:creator" content="@notrustverif" />

    <!-- Additional Meta Tags -->
    <meta name="description" content="Calculate your liquidation risk, maximum borrowable ABD, and safety margins for AlphBanx loans. Real-time price updates and position monitoring." />
    <meta name="keywords" content="ALPH, Alephium, AlphBanx, liquidation calculator, ABD, collateral ratio, DeFi, lending" />
    <meta name="author" content="@notrustverif" />
    <meta name="robots" content="index, follow" />

    <style>
      /* ------------------------
         THEME VARIABLES
      -------------------------*/
      :root {
        --bg: #f0f0f0;
        --grad-bg: linear-gradient(135deg, #f0f0f0 0%, #ffffff 100%);
        --container-bg: #ffffff;
        --text: #333333;
        --subtext: #666666;
        --primary: #3498db;
        --primary-hover: #2980b9;
        --safe: #2ecc71;
        --warning: #e74c3c;
        --caution: #f39c12;
        --border: #e0e0e0;
        --shadow: rgba(0, 0, 0, 0.1);
        --input-bg: #ffffff;
        --input-border: #dddddd;
      }

      [data-theme="dark"] {
        --bg: #1f1f1f;
        --grad-bg: linear-gradient(135deg, #1f1f1f 0%, #292929 100%);
        --container-bg: #2b2b2b;
        --text: #ffffff;
        --subtext: #aaaaaa;
        --primary: #a8e063;
        --primary-hover: #c2ff9f;
        --safe: #56ab2f;
        --warning: #ff6f61;
        --caution: #f39c12;
        --border: #444444;
        --shadow: rgba(0, 0, 0, 0.6);
        --input-bg: #444444;
        --input-border: #555555;
      }

      /* ------------------------
         RESET + GLOBALS
      -------------------------*/
      *,
      *::before,
      *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: system-ui, sans-serif;
      }

      html,
      body {
        height: 100%;
      }

      body {
        background: var(--grad-bg);
        color: var(--text);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        overflow: hidden;
        position: relative;
      }

      /* subtle grid overlay for dark theme */
      body::before {
        content: "";
        position: absolute;
        inset: 0;
        background: repeating-linear-gradient(
          45deg,
          rgba(255, 255, 255, 0.05),
          rgba(255, 255, 255, 0.05) 10px,
          transparent 10px,
          transparent 20px
        );
        opacity: 0.08;
        pointer-events: none;
        z-index: 0;
      }

      /* ------------------------
         CALCULATOR CONTAINER
      -------------------------*/
      .calculator {
        width: 100%;
        max-width: 380px;
        background: var(--container-bg);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 12px 32px var(--shadow);
        overflow-y: auto;
        max-height: 95vh;
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE 10+ */
        position: relative;
        z-index: 1;
        transition: box-shadow 0.3s ease;
      }

      .calculator:hover {
        box-shadow: 0 18px 38px var(--shadow);
      }

      .calculator::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
      }

      h2 {
        text-align: center;
        font-size: 1.6rem;
        margin-bottom: 12px;
        background: linear-gradient(90deg, var(--primary) 0%, var(--primary-hover) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      /* ------------------------
         EXTERNAL LINK
      -------------------------*/
      .dapp-link {
        text-align: center;
        margin-bottom: 18px;
      }

      .dapp-link a {
        text-decoration: none;
        font-size: 0.9rem;
        color: var(--primary);
      }

      .dapp-link a:hover {
        text-decoration: underline;
        color: var(--primary-hover);
      }

      /* ------------------------
         INPUTS & GROUPS
      -------------------------*/
      .input-group {
        margin-bottom: 18px;
      }

      .input-group label {
        display: block;
        font-size: 0.9rem;
        margin-bottom: 6px;
      }

      input[type="number"] {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--input-border);
        background: var(--input-bg);
        color: var(--text);
        font-size: 1rem;
        transition: border-color 0.25s ease, box-shadow 0.25s ease;
      }

      input[type="number"]:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.25);
      }

      .input-description {
        font-size: 0.8rem;
        color: var(--subtext);
        margin-top: 4px;
      }

      /* ------------------------
         SLIDER
      -------------------------*/
      .slider-container {
        margin: 12px 0 8px;
      }

      .slider-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        margin-bottom: 6px;
      }

      .borrow-amount {
        display: inline-block;
        min-width: 60px;
        padding: 2px 4px;
        border: 1px solid transparent;
        border-radius: 4px;
        cursor: pointer;
      }

      .borrow-amount:hover {
        background: var(--bg);
      }

      .borrow-amount.editing {
        border-color: var(--primary);
        background: var(--container-bg);
        cursor: text;
      }

      input[type="range"].slider {
        -webkit-appearance: none;
        width: 100%;
        height: 10px;
        border-radius: 5px;
        background: var(--input-border);
        outline: none;
      }

      input[type="range"].slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--primary);
        cursor: pointer;
        transition: background 0.3s ease;
      }

      input[type="range"].slider::-webkit-slider-thumb:hover {
        background: var(--primary-hover);
      }

      input[type="range"].slider::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--primary);
        cursor: pointer;
        transition: background 0.3s ease;
      }

      /* ------------------------
         RESULTS & STATUS TEXT
      -------------------------*/
      .result {
        text-align: center;
        font-weight: 600;
        font-size: 0.9rem;
        margin-top: 6px;
      }

      .result.safe {
        color: var(--safe);
      }
      .result.warning {
        color: var(--warning);
      }
      .result.caution {
        color: var(--caution);
      }

      /* ------------------------
         PRICE & LIQUIDATION INFO
      -------------------------*/
      .price-info {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 6px;
        font-size: 0.9rem;
        margin-top: 12px;
      }

      .refresh-icon {
        font-size: 1.2rem;
        cursor: pointer;
        color: var(--primary);
        transition: transform 0.6s linear;
      }

      .refresh-icon:hover {
        color: var(--primary-hover);
      }

      .refreshing {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .liquidation {
        margin-top: 16px;
        padding-top: 12px;
        border-top: 1px solid var(--border);
      }

      .borrow-info {
        background: var(--bg);
        padding: 12px;
        border-radius: 10px;
        border: 1px solid var(--border);
      }

      /* ------------------------
         FOOTER
      -------------------------*/
      .footer {
        margin-top: 24px;
        font-size: 0.8rem;
        text-align: center;
        color: var(--subtext);
        border-top: 1px solid var(--border);
        padding-top: 12px;
      }

      .footer a {
        color: var(--primary);
        text-decoration: none;
      }

      .footer a:hover {
        text-decoration: underline;
        color: var(--primary-hover);
      }

      /* ------------------------
         THEME TOGGLE BUTTON
      -------------------------*/
      #themeToggle {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background: var(--primary);
        color: #fff;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 4px 10px var(--shadow);
        transition: background 0.3s ease, transform 0.3s ease;
        z-index: 2;
      }

      #themeToggle:hover {
        background: var(--primary-hover);
        transform: translateY(-2px);
      }

      /* ------------------------
         MEDIA QUERIES
      -------------------------*/
      @media (max-width: 420px) {
        .calculator {
          padding: 18px;
        }
      }

      .address-fetch-group {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }
      .address-fetch-group input[type="text"] {
        flex: 1;
        padding: 6px;
        border: 1px solid var(--input-border);
        border-radius: 4px;
        font-size: 0.95em;
      }
      .address-fetch-group button {
        padding: 6px 12px;
        background: var(--primary);
        color: #fff;
        border: none;
        border-radius: 4px;
        font-size: 0.95em;
        cursor: pointer;
        transition: background 0.2s;
      }
      .address-fetch-group button:hover {
        background: var(--primary-hover);
      }
      .fetch-status {
        font-size: 0.85em;
        color: var(--subtext);
        margin-bottom: 6px;
        min-height: 18px;
      }
      .fetch-status.error {
        color: var(--warning);
      }
      .fetch-status.success {
        color: var(--safe);
      }
    </style>
  </head>
  <body>
    <div class="calculator">
      <button id="themeToggle" aria-label="Toggle dark mode">☾</button>
      <h2>ALPH Liquidation Calculator</h2>
      <div class="dapp-link">
        <a href="https://app.alphbanx.com/" target="_blank" rel="noopener"
          >Visit AlphBanx Dapp →</a
        >
      </div>

      <!-- Address fetch collateral -->
      <div class="input-group">
        <label for="fetchAddress">Paste your address to fetch ALPH collateral and borrowed ABD</label>
        <div class="address-fetch-group">
          <input type="text" id="fetchAddress" placeholder="Paste your address..." />
          <button type="button" onclick="fetchCollateralAndBorrowed()">Fetch Data</button>
        </div>
        <div class="fetch-status" id="fetchStatus"></div>
      </div>

      <!-- Collateral input -->
      <div class="input-group">
        <label for="alph">ALPH Collateral Amount</label>
        <input
          type="number"
          id="alph"
          placeholder="Enter ALPH amount"
          oninput="updateCalculator()"
        />
      </div>

      <!-- Existing borrow input -->
      <div class="input-group">
        <label for="existingBorrow">Current Borrowed ABD</label>
        <input
          type="number"
          id="existingBorrow"
          placeholder="Enter existing borrowed ABD"
          oninput="updateCalculator()"
        />
        <div class="input-description">
          Enter the amount you've already borrowed (if any)
        </div>
      </div>

      <!-- Borrow info section -->
      <div class="borrow-info">
        <div class="result" id="maxBorrow"></div>

        <div class="slider-container">
          <div class="slider-label">
            <span>Additional ABD to Borrow:</span>
            <span
              id="borrowAmount"
              class="borrow-amount"
              onclick="startEditing()"
              onblur="stopEditing()"
              >0 ABD</span
            >
          </div>
          <input
            type="range"
            id="borrowSlider"
            class="slider"
            min="0"
            max="1000"
            value="0"
            step="1"
            oninput="updateFromSlider()"
          />
        </div>

        <div class="result" id="totalBorrow"></div>
        <div class="result" id="collateralValue"></div>
        <div class="result" id="currentRatio"></div>
        <div class="result" id="minRequired"></div>
      </div>

      <!-- Price info -->
      <div class="result price-info">
        <span id="price">Loading ALPH price...</span>
        <span
          class="refresh-icon"
          onclick="manualRefresh()"
          title="Click to refresh"
          >⟳</span
        >
      </div>

      <!-- Liquidation info -->
      <div class="liquidation">
        <div class="result" id="liquidationPrice"></div>
        <div class="result" id="safetyMargin"></div>
      </div>

      <div class="result info">
        The minimum required collateral ratio is 200%. Keep your ratio above
        this to avoid liquidation risk.
      </div>

      <!-- Footer -->
      <div class="footer">
        Built by
        <a
          href="https://x.com/notrustverif"
          target="_blank"
          rel="noopener noreferrer"
          >@notrustverif</a
        >
        |
        <a
          href="https://notrustverify.ch"
          target="_blank"
          rel="noopener noreferrer"
          >notrustverify.ch</a
        >
      </div>
    </div>

    <script>
      /***********************
       *  THEME HANDLING    *
       ***********************/
      (function () {
        const themeToggle = document.getElementById("themeToggle");
        const root = document.documentElement;
        const storedTheme = localStorage.getItem("theme") || "light";
        root.setAttribute("data-theme", storedTheme);
        themeToggle.textContent = storedTheme === "dark" ? "☼" : "☾";

        themeToggle.addEventListener("click", () => {
          const current = root.getAttribute("data-theme");
          const next = current === "dark" ? "light" : "dark";
          root.setAttribute("data-theme", next);
          localStorage.setItem("theme", next);
          themeToggle.textContent = next === "dark" ? "☼" : "☾";
        });
      })();

      /***********************
       *  CALCULATOR LOGIC  *
       ***********************/
      let alphPrice = null;
      let lastUpdateTime = null;
      let lastAddressFetchTime = null;
      let currentAddress = null;
      const MIN_CR = 200; // 200%
      const REFRESH_INTERVAL = 30000; // 30s
      const ADDRESS_REFRESH_INTERVAL = 60000; // 60s for address data

      // Hex to binary decoder function
      function hexToBinUnsafe(hex) {
        const bytes = []
        for (let i = 0; i < hex.length; i += 2) {
          bytes.push(parseInt(hex.slice(i, i + 2), 16))
        }
        return new Uint8Array(bytes)
      }

      // Base58 encoding function
      function bs58Encode(bytes) {
        const alphabet = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz'
        const base = alphabet.length
        
        let num = 0n
        for (let i = 0; i < bytes.length; i++) {
          num = num * 256n + BigInt(bytes[i])
        }
        
        let result = ''
        while (num > 0) {
          const remainder = Number(num % BigInt(base))
          result = alphabet[remainder] + result
          num = num / BigInt(base)
        }
        
        // Add leading zeros
        for (let i = 0; i < bytes.length && bytes[i] === 0; i++) {
          result = '1' + result
        }
        
        return result
      }

      // Convert contract ID to address
      function addressFromContractId(contractId) {
        const P2C = 0x03
        const hash = hexToBinUnsafe(contractId)
        const bytes = new Uint8Array([P2C, ...hash])
        return bs58Encode(bytes)
      }


      // Fetch user's specific borrowed ABD
      async function fetchUserBorrowed(userAddress) {
        try {
          // First get the user's position address
          const contractId = await findAddressForParams(userAddress);
          const positionAddress = addressFromContractId(contractId);
          
          // Then fetch the borrowed amount for that position
          const response = await fetch('https://lb-fullnode-alephium.notrustverify.ch/contracts/call-contract', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              "args": [],
              "group": 0,
              "address": positionAddress,
              "methodIndex": 9
            })
          });
          
          const data = await response.json();
          if (data.type === "CallContractSucceeded" && data.returns && data.returns[0]) {
            const borrowedValue = data.returns[0].value;
            const borrowedABD = parseInt(borrowedValue) / Math.pow(10, 9);
            return borrowedABD;
          }
          return 0; // Return 0 if no borrowed amount found
        } catch (error) {
          console.error('Error fetching user borrowed:', error);
          return 0; // Return 0 on error
        }
      }

      // Find address for post parameters
      async function findAddressForParams(userAddress) {
        try {
          const response = await fetch('https://lb-fullnode-alephium.notrustverify.ch/contracts/call-contract', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              "args": [{
                "value": userAddress,
                "type": "Address"
              }],
              "group": 0,
              "address": "tpxjsWJSaUh5i7XzNAsTWMRtD9QvDTV9zmMNeHHS6jQB",
              "methodIndex": 23
            })
          });
          
          const data = await response.json();
          if (data.type === "CallContractSucceeded" && data.returns && data.returns[0]) {
            // Return the raw hex value from the API response
            return data.returns[0].value;
          }
          throw new Error('Invalid response format');
        } catch (error) {
          console.error('Error finding address for params:', error);
          throw error;
        }
      }

      // Enhanced fetch collateral function that also fetches borrowed amount
      async function fetchCollateralAndBorrowed() {
        const address = document.getElementById('fetchAddress').value.trim();
        const status = document.getElementById('fetchStatus');
        const alphInput = document.getElementById('alph');
        const existingBorrowInput = document.getElementById('existingBorrow');
        
        if (!address) {
          status.textContent = 'Please enter an address.';
          status.className = 'fetch-status error';
          currentAddress = null; // Clear current address
          return;
        }
        
        // Store the address for automatic refresh
        currentAddress = address;
        lastAddressFetchTime = new Date();
        
        status.textContent = 'Fetching collateral and borrowed amount...';
        status.className = 'fetch-status';
        
        try {
          // Fetch collateral
          const collateralRes = await fetch(`https://corsproxy.io/?https://api.alphbanx.com/api/loan/${address}`);
          if (collateralRes.status === 404) {
            status.textContent = 'Address does not have a loan on AlphBanx.';
            status.className = 'fetch-status error';
            return;
          }
          if (!collateralRes.ok) throw new Error('Network error');
          const collateralData = await collateralRes.json();
          
          // Fetch borrowed amount using the new API
          const borrowedAmount = await fetchUserBorrowed(address);
          
          if (typeof collateralData.currentCollateral === 'number') {
            alphInput.value = collateralData.currentCollateral;
            existingBorrowInput.value = borrowedAmount.toFixed(2);
            
            // Clear status on success - don't show success message
            status.textContent = '';
            status.className = 'fetch-status';
            updateCalculator();
          } else {
            status.textContent = 'No collateral found for this address.';
            status.className = 'fetch-status error';
          }
        } catch (e) {
          status.textContent = 'Could not fetch data. Please check the address or try again later.';
          status.className = 'fetch-status error';
        }
      }

      // Automatic refresh for address data
      async function autoRefreshAddressData() {
        if (currentAddress && lastAddressFetchTime) {
          const now = new Date();
          const timeSinceLastFetch = now - lastAddressFetchTime;
          
          if (timeSinceLastFetch >= ADDRESS_REFRESH_INTERVAL) {
            // Silently refresh without showing status messages
            const alphInput = document.getElementById('alph');
            const existingBorrowInput = document.getElementById('existingBorrow');
            
            try {
              // Fetch collateral
              const collateralRes = await fetch(`https://corsproxy.io/?https://api.alphbanx.com/api/loan/${currentAddress}`);
              if (collateralRes.ok && collateralRes.status !== 404) {
                const collateralData = await collateralRes.json();
                
                // Fetch borrowed amount
                const borrowedAmount = await fetchUserBorrowed(currentAddress);
                
                if (typeof collateralData.currentCollateral === 'number') {
                  alphInput.value = collateralData.currentCollateral;
                  existingBorrowInput.value = borrowedAmount.toFixed(2);
                  updateCalculator();
                }
              }
              
              lastAddressFetchTime = now;
            } catch (e) {
              // Silently fail for auto-refresh
              console.log('Auto-refresh failed:', e);
            }
          }
        }
      }

      function startEditing() {
        const borrowAmount = document.getElementById("borrowAmount");
        const currentValue = parseInt(borrowAmount.textContent) || 0;
        borrowAmount.textContent = currentValue;
        borrowAmount.contentEditable = true;
        borrowAmount.classList.add("editing");
        borrowAmount.focus();

        const range = document.createRange();
        range.selectNodeContents(borrowAmount);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);

        borrowAmount.addEventListener("keydown", handleKeyPress);
      }

      function handleKeyPress(e) {
        if (e.key === "Enter") {
          e.preventDefault();
          stopEditing();
        }
        if (
          !/[\d\s\b]/.test(e.key) &&
          !["ArrowLeft", "ArrowRight", "Delete", "Backspace"].includes(e.key)
        ) {
          e.preventDefault();
        }
      }

      function stopEditing() {
        const borrowAmount = document.getElementById("borrowAmount");
        const slider = document.getElementById("borrowSlider");
        borrowAmount.contentEditable = false;
        borrowAmount.classList.remove("editing");
        let value = parseInt(borrowAmount.textContent) || 0;
        const maxValue = parseInt(slider.max);
        if (value > maxValue) value = maxValue;
        borrowAmount.textContent = value + " ABD";
        slider.value = value;
        borrowAmount.removeEventListener("keydown", handleKeyPress);
        updateCalculator();
      }

      async function fetchPrice() {
        const icon = document.querySelector(".refresh-icon");
        icon.classList.add("refreshing");
        try {
          const res = await fetch(
            "https://api.diadata.org/v1/assetQuotation/Alephium/tgx7VNFoP9DJiFMFgXXtafQZkUvyEdDHT9ryamHJYrjq"
          );
          const data = await res.json();
          alphPrice = parseFloat(data.Price);
          lastUpdateTime = new Date();
          updatePriceDisplay();
          updateCalculator();
        } catch (err) {
          document.getElementById("price").textContent =
            "Error fetching ALPH price";
        } finally {
          icon.classList.remove("refreshing");
        }
      }

      function updatePriceDisplay() {
        if (alphPrice !== null && lastUpdateTime !== null) {
          const timeStr = lastUpdateTime.toLocaleTimeString();
          document.getElementById(
            "price"
          ).textContent = `Current ALPH Price: $${alphPrice.toFixed(
            4
          )} (Updated: ${timeStr})`;
        }
      }

      function manualRefresh() {
        fetchPrice();
      }

      function updateFromSlider() {
        const sliderValue = document.getElementById("borrowSlider").value;
        document.getElementById("borrowAmount").textContent =
          sliderValue + " ABD";
        updateCalculator();
      }

      function updateCalculator() {
        const alph =
          parseFloat(document.getElementById("alph").value) || 0;
        const existingBorrow =
          parseFloat(document.getElementById("existingBorrow").value) || 0;
        const borrowText =
          document.getElementById("borrowAmount").textContent;
        const additionalBorrow = parseFloat(borrowText) || 0;
        const totalBorrowed = existingBorrow + additionalBorrow;

        const collateralValue = document.getElementById("collateralValue");
        const currentRatio = document.getElementById("currentRatio");
        const minRequired = document.getElementById("minRequired");
        const liquidationPrice = document.getElementById("liquidationPrice");
        const safetyMargin = document.getElementById("safetyMargin");
        const maxBorrow = document.getElementById("maxBorrow");
        const totalBorrow = document.getElementById("totalBorrow");
        const slider = document.getElementById("borrowSlider");

        if (alph > 0 && alphPrice !== null) {
          const totalValue = alph * alphPrice;
          const maxBorrowAmount = (totalValue * 100) / MIN_CR;
          const remainingBorrowable = Math.max(
            0,
            maxBorrowAmount - existingBorrow
          );

          maxBorrow.textContent = `Maximum Additional Borrow: ${remainingBorrowable.toFixed(
            2
          )} ABD`;
          slider.max = Math.floor(remainingBorrowable);
          totalBorrow.textContent = `Total Borrowed: ${totalBorrowed.toFixed(
            2
          )} ABD`;

          if (totalBorrowed > 0) {
            const currentCR = (totalValue / totalBorrowed) * 100;
            const liqPrice = (totalBorrowed * MIN_CR) / (alph * 100);
            const priceDrop = ((alphPrice - liqPrice) / alphPrice) * 100;

            collateralValue.textContent = `Collateral Value: $${totalValue.toFixed(
              2
            )}`;
            currentRatio.textContent = `Current Ratio: ${currentCR.toFixed(2)}%`;

            currentRatio.className = "result";
            minRequired.className = "result";

            if (currentCR >= 300) {
              currentRatio.classList.add("safe");
              minRequired.textContent = "Safe: Very healthy collateral ratio";
              minRequired.classList.add("safe");
            } else if (currentCR >= 250) {
              currentRatio.classList.add("safe");
              minRequired.textContent = "Safe: Good collateral ratio";
              minRequired.classList.add("safe");
            } else if (currentCR >= 225) {
              currentRatio.classList.add("caution");
              minRequired.textContent =
                "Caution: Collateral ratio below 250%";
              minRequired.classList.add("caution");
            } else if (currentCR >= MIN_CR) {
              currentRatio.classList.add("warning");
              minRequired.textContent =
                "Warning: Collateral ratio below 225%";
              minRequired.classList.add("warning");
            } else {
              currentRatio.classList.add("warning");
              const minAlphNeeded =
                (totalBorrowed * MIN_CR) / (100 * alphPrice);
              const additionalAlphNeeded = minAlphNeeded - alph;
              minRequired.textContent = `Danger: Need ${additionalAlphNeeded.toFixed(
                2
              )} more ALPH to reach minimum 200%`;
              minRequired.classList.add("warning");
            }

            liquidationPrice.textContent = `Liquidation Price: $${liqPrice.toFixed(
              4
            )}`;

            if (priceDrop > 0) {
              safetyMargin.textContent = `Price can drop ${priceDrop.toFixed(
                2
              )}% before liquidation`;
              safetyMargin.className = "result";
              if (priceDrop >= 25) {
                safetyMargin.classList.add("safe");
              } else if (priceDrop >= 12.5) {
                safetyMargin.classList.add("caution");
              } else {
                safetyMargin.classList.add("warning");
              }
            } else {
              safetyMargin.textContent = "DANGER: Below liquidation price!";
              safetyMargin.className = "result warning";
            }
          } else {
            collateralValue.textContent = `Collateral Value: $${totalValue.toFixed(
              2
            )}`;
            currentRatio.textContent = "";
            minRequired.textContent = "";
            liquidationPrice.textContent = "";
            safetyMargin.textContent = "";
            totalBorrow.textContent = "";
          }
        } else {
          maxBorrow.textContent = "";
          collateralValue.textContent = "";
          currentRatio.textContent = "";
          minRequired.textContent = "";
          liquidationPrice.textContent = "";
          safetyMargin.textContent = "";
          totalBorrow.textContent = "";
        }
      }

      fetchPrice();
      setInterval(fetchPrice, REFRESH_INTERVAL);
      setInterval(autoRefreshAddressData, 10000); // Check every 10 seconds for address refresh
    </script>
  </body>
</html>
